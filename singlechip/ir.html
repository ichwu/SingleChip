<!DOCTYPE html>
<html lang="en">
 <head>
    <title>IR</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width initial-scale=1"/>
    <link rel="shortcut icon" type="image/x-icon" href="../../src/img/cover/cover_title.png"/>
    <!-- Prism -->
    <link rel="stylesheet" href="../../css/prism.css">
    <script src="../../js/prism.js"></script>
    <!-- 新 Bootstrap4 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <!-- bootstrap.bundle.min.js 用于弹窗、提示、下拉菜单，包含了 popper.min.js -->
    <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
    <!-- 最新的 Bootstrap4 核心 JavaScript 文件 -->
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!-- My style.css-->
    <link rel="stylesheet" href="../../css/bootstrap-m-style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
</head>
<body>

<a href="../index/singlechip.html">
<svg class="bi bi-arrow-left-square" width="3em" height="3em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
  <path fill-rule="evenodd" d="M8.354 11.354a.5.5 0 0 0 0-.708L5.707 8l2.647-2.646a.5.5 0 1 0-.708-.708l-3 3a.5.5 0 0 0 0 .708l3 3a.5.5 0 0 0 .708 0z"/>
  <path fill-rule="evenodd" d="M11.5 8a.5.5 0 0 0-.5-.5H6a.5.5 0 0 0 0 1h5a.5.5 0 0 0 .5-.5z"/>
</svg>
</a>

<br>
<div class="m-label">IR</div>
<pre><code class="language-html line-numbers">红外线是波长介于微波和可见光之间的电磁波，波长在 760 纳米到 1 毫米之间，是波形比红光长的非可见光。自然界中的一切物体，只要它的温度高于绝对零度(-273)就存在分子和原子的无规则运动，其表面就会不停的辐射红外线

发光二极管的亮度会随着电流的增大而增加，同样的道理，红外发射管发射红外线的强度也会随着电流的增大而增强

红外接收管内部是一个具有红外光敏感特征的 PN 节，属于光敏二极管，但是它只对红外光有反应。无红外光时，光敏管不导通，有红外光时，光敏管导通形成光电流，并且在一定范围内电流随着红外光的强度的增强而增大
</code></pre>

<img src="../../src/img/singlechip/ir-1.png">

<pre>发射部分：当发射控制输出高电平时，三极管 Q1 不导通，红外发射管 L1 不会发射红外信号；当发射控制输出低电平的时候，通过三极管 Q1 导通让 L1 发出红外光。
接收部分：R4 是一个电位器，我们通过调整电位器给 LM393 的 2 脚提供一个阈值电压，这个电压值的大小可以根据实际情况来调试确定。         而红外光敏二极管 L2收到红外光的   时候 会产生电流，并且随着红外光的从弱变强，电流会从小变大。当没有红外光或者说红外光很弱的时  候，3 脚的电压就会接近 VCC，如果 3 脚比 2 脚的电压高的话，通过 LM393 比较器后，接收检测引脚输出一个高电平。当随着光强变大，电流变大，3 脚的电压值等于 VCC-I*R3，电压就会越来越小，当小到一定程度，比 2 脚的电压还小的时候，接收检测引脚就会变为低电平

调制:  当信号是数据“0”的时候，38K 载波毫无保留的全部发送出去，当信号是数据“1”的时候，不发送任何载波信号</pre>


<img src="../../src/img/singlechip/ir-2.png">
<img src="../../src/img/singlechip/ir-3.png">
<img src="../../src/img/singlechip/ir-4.png">


<pre>38K 载波，我们可以用 455K 晶振，经过 12 分频得到 37.91K，也可以由时基电路 NE555来产生，或者使用单片机的 PWM 来产生。当信号输出引脚输出高电平时，Q2 截止，不管38K 载波信号如何控制 Q1，右侧的竖向支路都不会导通，红外管 L1 不会发送任何信息 
大多数家电遥控器的 38K 的占空比是 1/3

正常的通信来讲，接收端要首先对信号通过监测、放大、滤波、解调等等一系列电路处理，然后输出基带信号。但是红外通信的一体化接收头 HS0038B，已经把这些电路全部集成到一起了，我们只需要把这个电路接上去，就可以直接输出我们所要的基带信号了
由于红外接收头内部放大器的增益很大，很容易引起干扰，因此在接收头供电引脚上必须加上滤波电容，官方手册给的值是 4.7uF，我们这里直接用的 10uF，手册里还要求在供电引脚和电源之间串联 100 欧的电阻，进一步降低干扰

红外可以在 UART 中进行通信。当然，这个通信也不是没有限制的，比如在 HS0038B 的数据手册中标明，要想让 HS0038B 识别到 38K的红外信号，那么这个 38K 的载波必须要大于 10 个周期，这就限定了红外通信的基带信号的比特率必须不能高于 3800，那如果把串口输出的信号直接用 38K 调制的话，波特率也就不能高于 3800。当然还有很多其它基带协议可以利用红外来调制，下面我们介绍一种遥控器常用的红外通信协议——NEC 协议
常用
的就有 ITT 协议、NEC 协议、Sharp 协议、Philips RC-5 协议、Sony SIRC 协议等。用的最多的就是 NEC 协议了

NEC 协议的数据格式包括了引导码、用户码、用户码（或者用户码反码）、按键键码和键码反码，
最后一个停止位。停止位主要起隔离作用，一般不进行判断，编程时我们也不予理会。其中数据编码总共是 4 个字节 32 位
第一个字节是用户码，第二个字节可能也是用户码，或者是用户码的反码，具体由生产商决定，第三个字节就是当前按键
的键数据码，而第四个字节是键数据码的反码，可用于对数据的纠错。</pre>


<img src="../../src/img/singlechip/ir-5.png">

<pre>这个 NEC 协议，表示数据的方式不像我们之前学过的比如 UART 那样直观，而是每一位数据本身也需要进行编码，编码后再进行载波调制。
引导码：9ms 的载波+4.5ms 的空闲。
比特值“0”：560us 的载波+560us 的空闲。
比特值“1”：560us 的载波+1.68ms 的空闲</pre>

<img src="../../src/img/singlechip/ir-6.png">

<pre>从图上可以看出，先是 9ms 载波加 4.5ms 空闲的起始码，数据码是低位在前，高位在后，数据码第一个字节是8组560us的载波加560us的空闲，也就是0x00，第二个字节是8组560us的载波加 1.68ms 的空闲，可以看出来是 0xFF，这两个字节就是用户码和用户码的反码。按
键的键码二进制是 0x0C，反码就是 0xF3，最后跟了一个 560us 载波停止位。对于我们的遥控器来说，不同的按键，就是键码和键码反码的区分，用户码是一样的。这样我们就可以通过单片机的程序，把当前的按键的键码给解析出来。

我们前边学习中断的时候，学到 51 单片机有外部中断 0 和外部中断 1 这两个外部中断。
我们的红外接收引脚接到了 P3.3 引脚上，这个引脚的第二功能就是外部中断 1。
在寄存器TCON 中的 bit3 和 bit2 这两位，是和外部中断 1 相关的两位。
其中 IE1 是外部中断标志位，当外部中断发生后，这一位被自动置 1，和定时器中断标志位 TF 相似，进入中断后会自动清零，也可以软件清零。
bit2 是设置外部中断类型的，如果 bit2 为 0，那么只要 P3.3 为低电平就可以触发中断，如果 bit2 为 1，那么 P3.3 从高电平到低电平的下降沿发生才可以触发中断。
此外，外部中断 1 使能位是 EX1。那下面我们就把程序写出来，使用数码管把遥控器的用户码和键码显示出来。</pre>


<pre>Infrared.c 文件主要是用来检测红外通信的，当发生外部中断后，进入外部中断，通过定时器 1 定时，首先对引导码判断，而后对数据码的每个位逐位获取高低电平的时间，从而得知每一位是 0 还是 1，最终把数据码解出来
</pre>


<img src="../../src/img/singlechip/ir-7.png">

<pre>另外补充一点，遥控器的单按按键和持续按住按键发出来的信号是不同的。我们先来对
比一下两种按键方式的实测信号波形，如图 16-10 和 16-11 所示。</pre>


<img src="../../src/img/singlechip/ir-8.png">
<img src="../../src/img/singlechip/ir-9.png">

<pre>单次按键的结果 16-9 和我们之前的图 16-8 是一样的，这个不需要再解释。而持续按键，首先会发出一个和单次按键一样的波形出来，经过大概 40ms 后，会产生一个 9ms 载波加2.25ms 空闲，再跟一个停止位的波形，这个叫做重复码，而后只要你还在按住按键，那么每隔约 108ms 就会产生一个重复码。对于这个重复码我们的程序并没有对它单独解析，而是直接忽略掉了，这并不影响对正常按键数据的接收。如果你日后做程序时需要用到这个重复码，那么只需要再把对重复码的解析添加进来就可以了

大家在阅读这个程序时，会发现我们在获取高低电平时间的时候做了超时判断 if(TH1 >= 0x40)，这个超时判断主要是为了应对输入信号异常（比如意外的干扰等）情况的，如果不做超时判断，当输入信号异常时，程序就有可能会一直等待一个无法到来的跳变沿，而造成程序假死

main.c 文件的主要功能就是把获取到的红外遥控器的用户码和键码信息，传送到数码管上显示出来，并且通过定时器 T0 的 1ms 中断进行数码管的动态刷新。不知道大家经过试验发现没有，当我们按下遥控器按键的时候，数码管显示的数字会闪烁，这是什么原因呢？单片机的程序都是顺序执行的，一旦我们按下遥控器按键，单片机就会进入遥控器解码的中断程序内，而这个程序执行的时间又比较长，要几十个毫秒，而如果数码管动态刷新间隔超过10ms 后就会感觉到闪烁，因此这个闪烁是由于程序执行红外解码时，延误了数码管动态刷新造成的。
如何解决？前边我们讲过中断优先级问题，如果设置了中断的抢占优先级，就会产生中断嵌套。中断嵌套的原理，我们在前边讲中断的时候已经讲过一次了，大家可以回头再复习一下。那么这个程序中，有 2 个中断程序，一个是外部中断程序负责接收红外数据，一个是定时器中断程序负责数码管扫描，要使红外接收不耽误数码管扫描的执行，那么就必须让定时器中断对外部中断实现嵌套，即把定时器中断设置为高抢占优先级。定时器中断程序，执行时间只有几十个 us，即使打断了红外接收中断的执行，也最多是给每个位的时间测量附加了几十 us 的误差，而这个误差在最短 560us 的时间判断中完全是容许的，所以中断嵌套并不会影响红外数据的正常接收。在 main 函数中，大家把这行程序“//PT0 = 1;”的注释取消，也就是使这行代码生效，这样就设置了 T0 中断的高抢占优先级，再编译一下，下载到单片机里，然后按键试试，是不是没有任何闪烁了呢？而中断嵌套的意义也有所体会了吧。
</pre>




<img src="../../src/img/singlechip/ir-10.png">
<pre>引导码：9ms 载波+4.5ms 空闲。
0：600us 载波+560us 空闲。
1：600us 载波+1.68ms 空闲
停止：560us 载波 + 40ms 空闲
连续： 9ms 载波 2.25ms空闲 600us载波 96ms空闲

开始 设备码 设备反码 键码 键码反码 停止 连续

00000000    设备码             
11111111    设备反码                解码
00111000   OK           0x38        1C    
00011000   UP           0x18        18
01001010   DOWN    0x4A        52
00010000   LEFT        0x10         08
01011010   RIGHT     0x5A        5A     
10100010   1             0xA2        45
01100010   2             0x62         46
11100010   3             0xE2         47
00100010   4             0x22         44
00000010   5             0x02         40
11000010   6             0xC2         43
11100000   7             0xE0         07
10101000   8             0xA8        15
10010000   9             0x90         09
10011000   0             0x98         19
01101000   *              0x68        16
10110000   #             0xB0        0D
低位在前  高位在后
</pre>


<img src="../../src/img/singlechip/ir-11.png">
<pre>
00000000    设备码
11111111    设备反码
10100010    SHUTDOWN      0xA2  45
01100010    STOP                  0x62  46
00100010    MODE                 0x22  44
00000010    BACK                   0x02  40
11000010    EQ                       0xC2  43
11100000    PLAYBACK           0xE0  07
10101000    PLAYNEXT           0xA8  15
10010000    PLAY/STOP          0x90  09
01101000    VOLUP                 0x68  16
10011000    VOLDOWN          0x98  19
10110000    0                           0xD0  0d
00110000    1                           0x30  0C
00011000    2                           0x18  18
01111010    3                           0xBA  5E
00010000    4                           0x10  08
00111000    5                           0x38  1C
01011010    6                           0x5A  5a
01000010    7                           0x44  42
01001010    8                           0x4A  52
01010010    9                           0xA2  4a
</pre>

<img src="../../src/img/singlechip/ir-12.png">
<pre>起始：3ms载波 3ms空闲 
0：0.5ms载波 1.5ms空闲
1：0.5ms载波 2.5ms空闲
结束：0.5ms载波 4ms空闲0.5ms载波 22ms空闲

起始+设备码+键码+结束      重复

00000010     设备码  
00001011     POWER
00011100     SIGNAL
00101111     OK
00101011      UP
00101100      DOWN
00101101      LEFT
00101110      RIGHT
00010101      MENU
00110000      BACK
00111000      HOME
00010100      MUTE
01100010      MORE
00010011      VOL+
00010010      VOL-
00010001      CH+
00010000      CH-

</pre>


<img src="../../src/img/singlechip/ir-13.png">
</body>
</html>